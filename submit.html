<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>예측치 제출</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
      line-height: 1.5;
    }
    h1 { font-size: 1.4rem; margin-bottom: 12px; }
    label { display: block; margin-top: 12px; font-weight: 600; }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      margin-top: 16px;
      cursor: pointer;
    }
    #status {
      margin-top: 12px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1 id="titleH1">예측치 제출</h1>
  <p id="helpText" style="font-size:0.9rem;color:#555;">
    처음 한 번은 <b>이름/그룹번호/회차/값</b>을 입력하고,<br>
    이후에는 브라우저가 <b>이름/그룹번호</b>를 기억해서 회차와 값만 바꾸면 됩니다.
  </p>

  <form id="prediction-form">
    <label for="name" id="labelName">이름</label>
    <input id="name" type="text" required />

    <label for="group" id="labelGroup">그룹 번호 (예: 1, 2, 3...)</label>
    <input id="group" type="text" required />

    <label for="round" id="labelRound">회차</label>
    <select id="round" required>
      <option value="1">1회차</option>
      <option value="2">2회차</option>
      <option value="3">3회차</option>
      <option value="4">4회차</option>
      <option value="5">5회차</option>
      <option value="6">6회차</option>
    </select>

    <label for="value" id="labelValue">예측치 (숫자)</label>
    <input id="value" type="number" step="0.01" required />

    <button type="submit" id="submitBtn">제출하기</button>
  </form>

  <p id="status"></p>

  <!-- Firebase SDK (compat 버전) -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD85EPLcL_j7s-WOQ1FDimMKEYmzBFzapE",
      authDomain: "bean-counting.firebaseapp.com",
      projectId: "bean-counting",
      storageBucket: "bean-counting.firebasestorage.app",
      messagingSenderId: "700257917650",
      appId: "1:700257917650:web:c7821b3e1b1b5f1a366b0b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const uiDocRef = db.doc('settings/ui');

    const form = document.getElementById('prediction-form');
    const nameInput = document.getElementById('name');
    const groupInput = document.getElementById('group');
    const roundSelect = document.getElementById('round');
    const valueInput = document.getElementById('value');
    const statusEl = document.getElementById('status');

    const TEXT = {
      ko: {
        htmlLang: "ko",
        docTitle: "예측치 제출",
        h1: "예측치 제출",
        helpHtml:
          `처음 한 번은 <b>이름/그룹번호/회차/값</b>을 입력하고,<br>
           이후에는 브라우저가 <b>이름/그룹번호</b>를 기억해서 회차와 값만 바꾸면 됩니다.`,
        labelName: "이름",
        labelGroup: "그룹 번호 (예: 1, 2, 3...)",
        labelRound: "회차",
        labelValue: "예측치 (숫자)",
        submitBtn: "제출하기",
        roundOption: (r) => `${r}회차`,
        submitting: "제출 중입니다...",
        badInput: "입력값을 다시 확인해주세요.",
        success: (r) => `${r}회차 예측치가 성공적으로 제출되었습니다!`,
        fail: "제출 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
      },
      en: {
        htmlLang: "en",
        docTitle: "Submit Prediction",
        h1: "Submit Prediction",
        helpHtml:
          `For your first submission, enter <b>Name / Group / Round / Value</b>.<br>
           After that, the browser will remember your <b>Name / Group</b>, so you only need to change the round and value.`,
        labelName: "Name",
        labelGroup: "Group number (e.g., 1, 2, 3...)",
        labelRound: "Round",
        labelValue: "Prediction value (number)",
        submitBtn: "Submit",
        roundOption: (r) => `Round ${r}`,
        submitting: "Submitting...",
        badInput: "Please double-check your inputs.",
        success: (r) => `Your prediction for Round ${r} has been submitted successfully!`,
        fail: "An error occurred while submitting. Please try again shortly."
      }
    };

    let currentLang = "ko";
    function t() { return TEXT[currentLang] || TEXT.ko; }

    function renderSubmitUI() {
      const L = t();
      document.documentElement.lang = L.htmlLang;
      document.title = L.docTitle;

      document.getElementById('titleH1').textContent = L.h1;
      document.getElementById('helpText').innerHTML = L.helpHtml;

      document.getElementById('labelName').textContent = L.labelName;
      document.getElementById('labelGroup').textContent = L.labelGroup;
      document.getElementById('labelRound').textContent = L.labelRound;
      document.getElementById('labelValue').textContent = L.labelValue;
      document.getElementById('submitBtn').textContent = L.submitBtn;

      // round 옵션 텍스트
      Array.from(roundSelect.options).forEach(opt => {
        const r = parseInt(opt.value, 10);
        if (!isNaN(r)) opt.textContent = L.roundOption(r);
      });
    }

    // localStorage에서 저장된 이름/그룹 불러오기
    const savedName = localStorage.getItem('studentName');
    const savedGroup = localStorage.getItem('studentGroup');
    if (savedName) nameInput.value = savedName;
    if (savedGroup) groupInput.value = savedGroup;

    // 전역 lang 실시간 구독
    uiDocRef.onSnapshot(async (doc) => {
      if (!doc.exists) {
        try { await uiDocRef.set({ lang: "ko" }, { merge: true }); } catch (e) {}
        return;
      }
      const lang = (doc.data() && doc.data().lang) ? doc.data().lang : "ko";
      if (lang !== "ko" && lang !== "en") return;
      currentLang = lang;
      renderSubmitUI();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      statusEl.textContent = t().submitting;

      const name = nameInput.value.trim();
      const group = groupInput.value.trim();
      const round = parseInt(roundSelect.value, 10);
      const value = parseFloat(valueInput.value);

      if (!name || !group || isNaN(round) || isNaN(value)) {
        statusEl.textContent = t().badInput;
        return;
      }

      try {
        await db.collection('predictions').add({
          name,
          group,
          round,
          value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        localStorage.setItem('studentName', name);
        localStorage.setItem('studentGroup', group);

        statusEl.textContent = t().success(round);
        valueInput.value = '';
      } catch (err) {
        console.error(err);
        statusEl.textContent = t().fail;
      }
    });
  </script>
</body>
</html>

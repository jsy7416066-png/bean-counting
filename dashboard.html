<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ˆì¸¡ì¹˜ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
    }
    h1 { font-size: 1.4rem; margin-bottom: 4px; }
    p { font-size: 0.9rem; margin-top: 0; color: #555; }
    #chart-container {
      position: relative;
      height: 70vh;
      max-height: 600px;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <h1>ì˜ˆì¸¡ì¹˜ ì‚°ì ë„ (ì‹¤ì‹œê°„)</h1>
  <p>
    Xì¶•: íšŒì°¨(1~6), Yì¶•: ì˜ˆì¸¡ì¹˜<br/>
    ìƒ‰ê¹”: <b>ê·¸ë£¹ ë²ˆí˜¸</b>ë³„ë¡œ êµ¬ë¶„ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.<br/>
    ì ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ <b>í•™ìƒ ì´ë¦„</b>ì´ ë³´ì…ë‹ˆë‹¤.
  </p>

  <div id="chart-container">
    <canvas id="predictionChart"></canvas>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ğŸ”¹ 1) submit.htmlê³¼ ì™„ì „íˆ ê°™ì€ firebaseConfig ì¨ì•¼ í•¨
    const firebaseConfig = {
      apiKey: "AIzaSyD85EPLcL_j7s-WOQ1FDimMKEYmzBFzapE",
      authDomain: "bean-counting.firebaseapp.com",
      projectId: "bean-counting",
      storageBucket: "bean-counting.firebasestorage.app",
      messagingSenderId: "700257917650",
      appId: "1:700257917650:web:c7821b3e1b1b5f1a366b0b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ctx = document.getElementById('predictionChart').getContext('2d');

    // ğŸ”¹ 2) Chart.js ì‚°ì ë„ ì´ˆê¸°í™”
    const predictionChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: []
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: function (context) {
                const point = context.raw;           // {x, y, name}
                const name = point.name || 'ì´ë¦„ ë¯¸ìƒ';
                const round = context.parsed.x;
                const value = context.parsed.y;
                return `${name} - ${round}íšŒì°¨: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: { display: true, text: 'íšŒì°¨' },
            ticks: {
              stepSize: 1,
              callback: (value) => `${value}íšŒì°¨`
            },
            min: 1,
            max: 6
          },
          y: {
            title: { display: true, text: 'ì˜ˆì¸¡ì¹˜' }
          }
        }
      }
    });

    // ğŸ”¹ 3) ê·¸ë£¹ë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
    const groupColors = [
      '#e41a1c', '#377eb8', '#4daf4a', '#984ea3',
      '#ff7f00', '#a65628', '#f781bf', '#999999'
    ];

    // ğŸ”¹ 4) Firestore ì‹¤ì‹œê°„ êµ¬ë… â†’ ê·¸ë£¹ë³„ë¡œ ë°ì´í„°ì…‹ êµ¬ì„±
    db.collection('predictions')
      .orderBy('round', 'asc')
      .onSnapshot((snapshot) => {
        const groupMap = {};  // { groupName: [{x, y, name}, ...] }

        snapshot.forEach((doc) => {
          const data = doc.data();
          const group = (data.group || 'ê¸°íƒ€').toString();

          if (typeof data.round === 'number' && typeof data.value === 'number') {
            if (!groupMap[group]) groupMap[group] = [];
            groupMap[group].push({
              x: data.round,
              y: data.value,
              name: data.name || ''   // ğŸ”¸ ì´ë¦„ í•¨ê»˜ ì €ì¥
            });
          }
        });

        const groupNames = Object.keys(groupMap).sort();
        const datasets = groupNames.map((groupName, idx) => ({
          label: `ê·¸ë£¹ ${groupName}`,              // ë²”ë¡€ì—ëŠ” ì—¬ì „íˆ ê·¸ë£¹ í‘œì‹œ
          data: groupMap[groupName],
          pointRadius: 4,
          backgroundColor: groupColors[idx % groupColors.length]
        }));

        predictionChart.data.datasets = datasets;
        predictionChart.update();
      }, (error) => {
        console.error('ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë… ì¤‘ ì˜¤ë¥˜:', error);
      });

  </script>
</body>
</html>

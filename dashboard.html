<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ˆì¸¡ì¹˜ ëŒ€ì‹œë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
    }
    h1 { font-size: 1.4rem; margin-bottom: 4px; }
    p { font-size: 0.9rem; margin-top: 0; color: #555; }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #top-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
    }

    .top-button {
      background-color: #e5e5e5; /* ì—°í•œ íšŒìƒ‰ */
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
    }
    .top-button:hover {
      background-color: #dcdcdc;
    }

    #chart-container {
      position: relative;
      height: 70vh;
      max-height: 600px;
      margin-top: 40px;
    }
  </style>
</head>
<body>

  <!-- ìƒë‹¨ ìš°ì¸¡ ë²„íŠ¼ë“¤ -->
  <div id="top-buttons">
    <button id="downloadCsvBtn" class="top-button">CSV ë‹¤ìš´ë¡œë“œ</button>
    <button id="resetBtn" class="top-button">ì´ˆê¸°í™”</button>
  </div>

  <h1>ì˜ˆì¸¡ì¹˜ ì‚°ì ë„ (ì‹¤ì‹œê°„)</h1>
  <p>
    Xì¶•: íšŒì°¨(1~6), Yì¶•: ì˜ˆì¸¡ì¹˜<br/>
    ìƒ‰ê¹”: <b>ê·¸ë£¹ ë²ˆí˜¸</b>ë³„ë¡œ êµ¬ë¶„ë˜ì–´ í‘œì‹œë©ë‹ˆë‹¤.<br/>
    ì ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ <b>í•™ìƒ ì´ë¦„</b>ì´ ë³´ì…ë‹ˆë‹¤.
  </p>

  <div id="chart-container">
    <canvas id="predictionChart"></canvas>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* ğŸ”¹ Firebase Config (submit.htmlê³¼ ë™ì¼í•˜ê²Œ!) */
    const firebaseConfig = {
      apiKey: "AIzaSyD85EPLcL_j7s-WOQ1FDimMKEYmzBFzapE",
      authDomain: "bean-counting.firebaseapp.com",
      projectId: "bean-counting",
      storageBucket: "bean-counting.firebasestorage.app",
      messagingSenderId: "700257917650",
      appId: "1:700257917650:web:c7821b3e1b1b5f1a366b0b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ctx = document.getElementById('predictionChart').getContext('2d');

    /* ğŸ”¹ ì°¨íŠ¸ ì´ˆê¸°í™” */
    const predictionChart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: (context) => {
                const p = context.raw;
                const name = p.name || 'ì´ë¦„ ë¯¸ìƒ';
                const round = context.parsed.x;
                const value = context.parsed.y;
                return `${name} - ${round}íšŒì°¨: ${value}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            position: 'bottom',
            title: { display: true, text: 'íšŒì°¨' },
            ticks: { stepSize: 1, callback: v => `${v}íšŒì°¨` },
            min: 1, max: 6
          },
          y: {
            title: { display: true, text: 'ì˜ˆì¸¡ì¹˜' }
          }
        }
      }
    });

    const groupColors = [
      '#e41a1c', '#377eb8', '#4daf4a', '#984ea3',
      '#ff7f00', '#a65628', '#f781bf', '#999999'
    ];

    /* ğŸ”¹ ì‹¤ì‹œê°„ Firestore Listener */
    db.collection('predictions')
      .orderBy('round', 'asc')
      .onSnapshot((snapshot) => {
        const groupMap = {};

        snapshot.forEach((doc) => {
          const data = doc.data();
          const group = (data.group || 'ê¸°íƒ€').toString();

          if (!groupMap[group]) groupMap[group] = [];
          groupMap[group].push({
            x: data.round,
            y: data.value,
            name: data.name
          });
        });

        const groupNames = Object.keys(groupMap).sort();
        const datasets = groupNames.map((groupName, idx) => ({
          label: `ê·¸ë£¹ ${groupName}`,
          data: groupMap[groupName],
          pointRadius: 4,
          backgroundColor: groupColors[idx % groupColors.length]
        }));

        predictionChart.data.datasets = datasets;
        predictionChart.update();
      });

    /* ------------------------------- */
    /*  ğŸ”¥ CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥             */
    /* ------------------------------- */

    document.getElementById("downloadCsvBtn").addEventListener("click", async () => {
      const snapshot = await db.collection("predictions").get();
      let rows = [["name","group","round","value","timestamp"]];

      snapshot.forEach(doc => {
        const d = doc.data();
        rows.push([
          d.name,
          d.group,
          d.round,
          d.value,
          d.createdAt?.toDate?.() || ""
        ]);
      });

      const csvContent =
        "data:text/csv;charset=utf-8," +
        rows.map(e => e.join(",")).join("\n");

      const link = document.createElement("a");
      link.href = encodeURI(csvContent);
      link.download = `predictions_backup_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    });


    /* ------------------------------- */
    /*  ğŸ”¥ ì´ˆê¸°í™” ê¸°ëŠ¥ (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)   */
    /* ------------------------------- */

    const RESET_PASSWORD = "SNU-TA-Reset-9237!";

    document.getElementById("resetBtn").addEventListener("click", async () => {
      const input = prompt("ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

      if (input !== RESET_PASSWORD) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      const really = confirm("âš  ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?");
      if (!really) return;

      const snapshot = await db.collection("predictions").get();
      const batch = db.batch();

      snapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
    });
  </script>
</body>
</html>

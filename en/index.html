<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prediction Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
    }
    h1 { font-size: 1.4rem; margin-bottom: 4px; }
    p { font-size: 0.9rem; margin-top: 0; color: #555; }

    /* Top-right buttons */
    #top-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .top-button {
      background-color: #e5e5e5;
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
    }
    .top-button:hover {
      background-color: #dcdcdc;
    }

    /* Round buttons */
    #round-buttons {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .round-button {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
    }
    .round-button.active {
      background-color: #ddd;
      font-weight: 600;
    }

    #chart-container {
      position: relative;
      height: 70vh;
      max-height: 600px;
      margin-top: 16px;
    }

    /* Round statistics overlay */
    #roundOverlay {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 60%;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border: 2px solid #666;
      padding: 24px;
      display: none;
      z-index: 5;
      box-sizing: border-box;
    }
    #roundOverlay h2 {
      margin-top: 0;
      font-size: 1.4rem;
      font-weight: 700;
    }
    #roundOverlay p {
      font-size: 1rem;
      font-weight: 600;
      margin: 6px 0;
      color: #444;
    }
    #roundOverlay p.label-group {
      margin-top: 8px;
      margin-bottom: 4px;
    }
    #roundOverlay ul {
      margin: 4px 0 18px 0;
      padding-left: 20px;
    }
    #roundOverlay li {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 2px 0;
    }
    #roundOverlay p.overall-line,
    #roundOverlay p.closest-line {
      font-size: 1.05rem;
      font-weight: 700;
      color: #000;
      margin-top: 6px;
    }
  </style>
</head>
<body>

  <!-- Top-right buttons -->
  <div id="top-buttons">
    <button id="toggleActualBtn" class="top-button">Show actual value</button>
    <button id="downloadCsvBtn" class="top-button">Download CSV</button>
    <button id="resetBtn" class="top-button">Reset</button>
  </div>

  <h1>Prediction Scatter Plot (Real-Time)</h1>
  <p>
    X-axis: Round (1–6), Y-axis: Prediction value<br/>
    Colors indicate <b>group numbers</b>.<br/>
    Hover over a point to see the <b>student name and their overall trend line</b>.<br/>
    Use the round buttons below to view <b>group means, overall mean, and the student closest to the mean</b>.
  </p>

  <!-- Round buttons -->
  <div id="round-buttons">
    <button class="round-button" data-round="1">Round 1</button>
    <button class="round-button" data-round="2">Round 2</button>
    <button class="round-button" data-round="3">Round 3</button>
    <button class="round-button" data-round="4">Round 4</button>
    <button class="round-button" data-round="5">Round 5</button>
    <button class="round-button" data-round="6">Round 6</button>
  </div>

  <div id="chart-container">
    <canvas id="predictionChart"></canvas>
    <div id="roundOverlay"></div>
  </div>

  <!-- Firebase & Chart.js -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD85EPLcL_j7s-WOQ1FDimMKEYmzBFzapE",
      authDomain: "bean-counting.firebaseapp.com",
      projectId: "bean-counting",
      storageBucket: "bean-counting.firebasestorage.app",
      messagingSenderId: "700257917650",
      appId: "1:700257917650:web:c7821b3e1b1b5f1a366b0b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ctx = document.getElementById('predictionChart').getContext('2d');
    const roundOverlayEl = document.getElementById('roundOverlay');
    const roundButtons = document.querySelectorAll('.round-button');

    const ACTUAL_VALUE = 1616;
    const RESET_PASSWORD  = "SNU-TA-Reset-9237!";
    const ACTUAL_PASSWORD = "1616";

    let baseDatasets = [];
    let highlightDataset = null;
    let actualVisible   = false;
    let actualUnlocked  = false;
    let allPoints = [];
    let roundStats = {};
    let currentRoundShown = null;

    function makeActualDataset() {
      const lineData = [];
      for (let r = 1; r <= 6; r++) {
        lineData.push({ x: r, y: ACTUAL_VALUE });
      }
      return {
        type: 'line',
        label: 'Actual',
        data: lineData,
        borderColor: 'red',
        borderWidth: 4,
        pointRadius: 0,
        fill: false
      };
    }

    function applyDatasets() {
      const datasets = [...baseDatasets];
      if (actualVisible) datasets.push(makeActualDataset());
      if (highlightDataset) datasets.push(highlightDataset);
      predictionChart.data.datasets = datasets;
      predictionChart.update();
    }

    const predictionChart = new Chart(ctx, {
      type: 'scatter',
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: (context) => {
                const p = context.raw;
                const name = p.name || 'Unknown';
                return `${name} – Round ${context.parsed.x}: ${context.parsed.y}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            min: 1,
            max: 6,
            ticks: { stepSize: 1, callback: v => `Round ${v}` },
            title: { display: true, text: 'Round' }
          },
          y: {
            title: { display: true, text: 'Prediction Value' }
          }
        }
      }
    });

    document.getElementById("toggleActualBtn").addEventListener("click", () => {
      if (!actualUnlocked) {
        const input = prompt("Enter the password to reveal the actual value:");
        if (input !== ACTUAL_PASSWORD) {
          alert("Incorrect password.");
          return;
        }
        actualUnlocked = true;
      }

      actualVisible = !actualVisible;
      document.getElementById("toggleActualBtn").textContent =
        actualVisible ? "Hide actual value" : "Show actual value";

      applyDatasets();
    });

    document.getElementById("resetBtn").addEventListener("click", async () => {
      const input = prompt("Enter the reset password:");
      if (input !== RESET_PASSWORD) {
        alert("Incorrect password.");
        return;
      }

      const really = confirm("⚠ Are you sure you want to delete all data?");
      if (!really) return;

      const snapshot = await db.collection("predictions").get();
      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      alert("All data has been reset.");
    });
  </script>
</body>
</html>
